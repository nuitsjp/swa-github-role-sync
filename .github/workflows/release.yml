name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description:
          'SemVer string (e.g. 1.2.3 or 1.2.3-beta.1). Prefix "v" is optional.'
        required: true
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Determine version
        id: meta
        run: |
          set -euo pipefail
          semver_regex='^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$'
          if [[ "${{ github.event_name }}" == "push" ]]; then
            tag="${GITHUB_REF#refs/tags/}"
            version="${tag#v}"
            if [[ ! $version =~ $semver_regex ]]; then
              echo "::error::Tag ${tag} does not look like SemVer" >&2
              exit 1
            fi
            echo "version=$version" >> "$GITHUB_OUTPUT"
            echo "tag=$tag" >> "$GITHUB_OUTPUT"
            echo "create_tag=false" >> "$GITHUB_OUTPUT"
            if [[ $version == *-* ]]; then
              echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            else
              echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            fi
          else
            input="${{ github.event.inputs.version }}"
            input=${input#v}
            if [[ -z "$input" ]]; then
              echo "::error::Version input is required" >&2
              exit 1
            fi
            if [[ ! $input =~ $semver_regex ]]; then
              echo "::error::Version $input is not SemVer" >&2
              exit 1
            fi
            tag="v$input"
            if git rev-parse "$tag" >/dev/null 2>&1; then
              echo "::error::Tag $tag already exists" >&2
              exit 1
            fi
            echo "version=$input" >> "$GITHUB_OUTPUT"
            echo "tag=$tag" >> "$GITHUB_OUTPUT"
            echo "create_tag=true" >> "$GITHUB_OUTPUT"
            if [[ $input == *-* ]]; then
              echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            else
              echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Create release tag
        if: steps.meta.outputs.create_tag == 'true'
        run: |
          git tag -a "${{ steps.meta.outputs.tag }}" -m "Release ${{ steps.meta.outputs.tag }}"

      - name: Push release tag
        if: steps.meta.outputs.create_tag == 'true'
        run: git push origin "${{ steps.meta.outputs.tag }}"

      - name: Update floating tag
        if: steps.meta.outputs.is_prerelease != 'true'
        run: |
          git tag -f v1 "${{ steps.meta.outputs.tag }}"
          git push origin v1 --force

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ steps.meta.outputs.tag }}"
          is_prerelease="${{ steps.meta.outputs.is_prerelease }}"
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Release $tag already exists. Skipping creation."
            exit 0
          fi
          flags=(--generate-notes --title "Release $tag")
          if [[ "$is_prerelease" == "true" ]]; then
            flags+=(--prerelease)
          else
            flags+=(--latest)
          fi
          gh release create "$tag" "${flags[@]}"
