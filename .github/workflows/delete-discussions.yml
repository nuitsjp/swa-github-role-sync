name: Delete All Discussions

on:
  workflow_dispatch:

permissions:
  contents: read
  discussions: write

jobs:
  purge:
    name: Purge Discussions
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Delete all Discussions
        run: |
          set -euo pipefail

          owner="${GITHUB_REPOSITORY%/*}"
          name="${GITHUB_REPOSITORY#*/}"
          MAX_RETRIES=5

          query=$(cat <<'GRAPHQL'
          query ($owner: String!, $name: String!, $cursor: String) {
            repository(owner: $owner, name: $name) {
              discussions(first: 100, after: $cursor) {
                nodes {
                  id
                  number
                  title
                  url
                }
                pageInfo {
                  hasNextPage
                  endCursor
                }
              }
            }
          }
          GRAPHQL
          )

          mutation=$(cat <<'GRAPHQL'
          mutation ($id: ID!) {
            deleteDiscussion(input: {id: $id}) {
              clientMutationId
            }
          }
          GRAPHQL
          )

          fetch_page() {
            local cursor_value="$1"
            local page
            local attempt=1
            while [ "$attempt" -le "$MAX_RETRIES" ]; do
              if [ -z "$cursor_value" ]; then
                if page=$(gh api graphql -F owner="$owner" -F name="$name" -f query="$query"); then
                  echo "$page"
                  return 0
                fi
              else
                if page=$(gh api graphql -F owner="$owner" -F name="$name" -F cursor="$cursor_value" -f query="$query"); then
                  echo "$page"
                  return 0
                fi
              fi
              echo "Failed to fetch discussions (attempt $attempt/$MAX_RETRIES); retrying..." >&2
              sleep $((attempt * 2))
              attempt=$((attempt + 1))
            done
            echo "Failed to fetch discussions after $MAX_RETRIES attempts." >&2
            return 1
          }

          delete_with_retry() {
            local id="$1"
            local number="$2"
            local title="$3"
            local url="$4"
            local attempt=1

            while [ "$attempt" -le "$MAX_RETRIES" ]; do
              if gh api graphql -F id="$id" -f query="$mutation" >/dev/null; then
                printf 'Deleted Discussion #%s "%s" (%s)\n' "$number" "$title" "$url"
                return 0
              fi
              echo "Failed to delete Discussion #$number (attempt $attempt/$MAX_RETRIES); retrying..." >&2
              sleep $((attempt * 2))
              attempt=$((attempt + 1))
            done

            echo "Giving up on Discussion #$number after $MAX_RETRIES attempts." >&2
            return 1
          }

          deleted=0
          cursor=""

          while :; do
            if ! response=$(fetch_page "$cursor"); then
              exit 1
            fi

            count=$(echo "$response" | jq '.data.repository.discussions.nodes | length')

            if [ "$count" -eq 0 ]; then
              echo "No Discussions found on this page."
              break
            fi

            while IFS= read -r node; do
              id=$(echo "$node" | jq -r '.id')
              number=$(echo "$node" | jq -r '.number')
              title=$(echo "$node" | jq -r '.title')
              url=$(echo "$node" | jq -r '.url')

              delete_with_retry "$id" "$number" "$title" "$url"
              deleted=$((deleted + 1))
            done < <(echo "$response" | jq -c '.data.repository.discussions.nodes[]')

            page_info=$(echo "$response" | jq '.data.repository.discussions.pageInfo')
            if [ "$(echo "$page_info" | jq -r '.hasNextPage')" = "true" ]; then
              cursor=$(echo "$page_info" | jq -r '.endCursor')
            else
              break
            fi
          done

          echo "Deleted $deleted Discussions in total."
