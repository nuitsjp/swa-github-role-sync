name: Sync Azure Static Web App Users

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual trigger context (optional)'
        required: false
        default: ''
        type: string
  schedule:
    - cron: '0 0 * * *'

jobs:
  sync-users:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      STATIC_WEB_APP_NAME: ${{ secrets.AZURE_STATIC_WEB_APP_NAME }}
      RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      DISCUSSION_ENABLED: ${{ secrets.SWA_DISCUSSION_ENABLED }}
      DISCUSSION_CATEGORY_ID: ${{ secrets.SWA_DISCUSSION_CATEGORY_ID }}
      DISCUSSION_TITLE: ${{ secrets.SWA_DISCUSSION_TITLE }}
      DISCUSSION_BODY_TEMPLATE: ${{ secrets.SWA_DISCUSSION_BODY_TEMPLATE }}
      INVITATION_EXPIRES_HOURS: ${{ secrets.SWA_INVITATION_EXPIRES_HOURS }}

    steps:
      - name: Ensure GITHUB_TOKEN is available
        run: |
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "GITHUB_TOKEN is required for GitHub API access and Discussion postings." >&2
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Sync Static Web App users
        run: |
          set -euo pipefail

          repo="${GITHUB_REPOSITORY:-}"
          if [[ -z "$repo" ]]; then
            echo "::error::GITHUB_REPOSITORY が設定されていません。"
            exit 1
          fi

          for var_name in STATIC_WEB_APP_NAME RESOURCE_GROUP; do
            if [[ -z "${!var_name:-}" ]]; then
              echo "::error::${var_name} が設定されていません。"
              exit 1
            fi
          done

          if [[ -n "${SUBSCRIPTION_ID:-}" ]]; then
            echo "Azure サブスクリプションを設定: ${SUBSCRIPTION_ID}"
            az account set --subscription "$SUBSCRIPTION_ID"
          fi

          if ! command -v gh >/dev/null 2>&1; then
            echo "::error::GitHub CLI (gh) が見つかりません。"
            exit 1
          fi

          if ! command -v jq >/dev/null 2>&1; then
            echo "::error::jq が見つかりません。"
            exit 1
          fi

          echo "GitHub 認証状態を確認中..."
          if ! gh auth status -h github.com >/dev/null 2>&1; then
            gh auth status -h github.com || true
            echo "::error::GitHub CLI で認証できませんでした。"
            exit 1
          fi

          replace_placeholders() {
            local value="$1"
            local username="$2"
            local invitation="$3"

            DISCUSSION_VALUE="$value" python - "$username" "$invitation" <<'PY'
import os
import sys

text = os.environ.get("DISCUSSION_VALUE", "")
username = sys.argv[1]
invitation = sys.argv[2]

replacements = {
    "{{USERNAME}}": username,
    "{{username}}": username,
    "{USERNAME}": username,
    "{username}": username,
    "{{INVITATION_URL}}": invitation,
    "{{invitation_url}}": invitation,
    "{INVITATION_URL}": invitation,
    "{invitation_url}": invitation,
}

for key, replacement in replacements.items():
    text = text.replace(key, replacement)

print(text, end="")
PY
          }

          echo "GitHub コラボレーターを取得中..."
          mapfile -t gh_users < <(
            gh api "repos/${repo}/collaborators" --paginate --jq '.[] | select(.permissions.push == true or .permissions.admin == true or .permissions.maintain == true) | .login'
          )
          echo "GitHub コラボレーター数: ${#gh_users[@]}"
          if [[ ${#gh_users[@]} -gt 0 ]]; then
            printf 'GitHub コラボレーター一覧:\n'
            for user in "${gh_users[@]}"; do
              printf ' - %s\n' "$user"
            done
          else
            echo "push 権限を持つコラボレーターは見つかりませんでした。"
          fi

          echo "Azure Static Web App ユーザーを取得中..."
          azure_raw="$(az staticwebapp users list --name "$STATIC_WEB_APP_NAME" --resource-group "$RESOURCE_GROUP" -o json)"

          declare -A azure_map=()
          declare -A azure_id_map=()
          declare -A azure_display_map=()
          declare -A azure_provider_map=()

          while IFS= read -r encoded; do
            [[ -z "$encoded" ]] && continue
            data="$(printf '%s' "$encoded" | base64 --decode)"
            login_candidate="$(echo "$data" | jq -r '.userDetails // .displayName // ""')"
            user_id="$(echo "$data" | jq -r '.userId // .name // ""')"
            display_name="$(echo "$data" | jq -r '.displayName // .userDetails // ""')"
            provider="$(echo "$data" | jq -r '.provider // ""')"

            login="${login_candidate##*|}"
            if [[ -z "$login" ]]; then
              login="${user_id##*|}"
            fi
            if [[ -z "$login" ]]; then
              continue
            fi

            login_lower="$(echo "$login" | tr '[:upper:]' '[:lower:]')"
            azure_map["$login_lower"]="$login"
            azure_id_map["$login_lower"]="$user_id"
            azure_display_map["$login_lower"]="$display_name"
            azure_provider_map["$login_lower"]="$provider"
          done < <(
            echo "$azure_raw" | jq -r '
              def ascii_lower:
                explode
                | map(if 65 <= . and . <= 90 then . + 32 else . end)
                | implode;

              map(
                {
                  userId: (.userId // .name // ""),
                  userDetails: (.userDetails // .displayName // ""),
                  displayName: (.displayName // .userDetails // ""),
                  provider: (.provider // ""),
                  roles: (
                    (if (.roles | type) == "array" then .roles
                     elif (.roles | type) == "string" then [(.roles)]
                     else [] end)
                    +
                    (if (.assignedRoleNames | type) == "array" then .assignedRoleNames
                     elif (.assignedRoleNames | type) == "string" then [(.assignedRoleNames)]
                     else [] end)
                  )
                }
              )
              | .[]
              | select(any(.roles[]?; ((. | ascii_lower) == "github_collaborator")))
              | @base64
            '
          )

          echo "Azure 上の github_collaborator ロールユーザー数: ${#azure_map[@]}"
          if [[ ${#azure_map[@]} -gt 0 ]]; then
            printf 'Azure ユーザー一覧:\n'
            for key in "${!azure_map[@]}"; do
              login="${azure_map[$key]}"
              user_id="${azure_id_map[$key]}"
              display="${azure_display_map[$key]}"
              printf ' - %s (ID: %s, 表示名: %s)\n' "$login" "$user_id" "$display"
            done
          else
            echo "Azure 側の github_collaborator ユーザーは登録されていません。"
          fi

          declare -A gh_map
          for user in "${gh_users[@]}"; do
            trimmed="$(echo "$user" | xargs)"
            [[ -z "$trimmed" ]] && continue
            lower="$(echo "$trimmed" | tr '[:upper:]' '[:lower:]')"
            gh_map["$lower"]="$trimmed"
          done

          to_add=()
          for key in "${!gh_map[@]}"; do
            if [[ -z "${azure_map[$key]+_}" ]]; then
              to_add+=("${gh_map[$key]}")
            fi
          done

          to_remove_keys=()
          for key in "${!azure_map[@]}"; do
            if [[ -z "${gh_map[$key]+_}" ]]; then
              to_remove_keys+=("$key")
            fi
          done

          echo "追加対象: ${#to_add[@]} 件"
          if [[ ${#to_add[@]} -gt 0 ]]; then
            for user in "${to_add[@]}"; do
              printf ' - %s\n' "$user"
            done
          fi

          echo "削除対象: ${#to_remove_keys[@]} 件"
          if [[ ${#to_remove_keys[@]} -gt 0 ]]; then
            for key in "${to_remove_keys[@]}"; do
              login="${azure_map[$key]}"
              display="${azure_display_map[$key]}"
              label="$login"
              if [[ -n "$display" && "$display" != "$login" ]]; then
                label="${display}（${login}）"
              fi
              printf ' - %s\n' "$label"
            done
          fi

          if [[ ${#to_add[@]} -eq 0 && ${#to_remove_keys[@]} -eq 0 ]]; then
            echo "同期対象の差分はありません。"
            exit 0
          fi

          expires="${INVITATION_EXPIRES_HOURS:-168}"
          if ! [[ "$expires" =~ ^[0-9]+$ ]] || (( expires <= 0 )); then
            echo "招待リンク有効期限 '${INVITATION_EXPIRES_HOURS:-}' は無効です。168 時間を使用します。"
            expires=168
          fi

          domain="$(az staticwebapp show --name "$STATIC_WEB_APP_NAME" --resource-group "$RESOURCE_GROUP" --query defaultHostname -o tsv)"

          invite_success=0
          invite_fail=0
          declare -a invitations

          if [[ ${#to_add[@]} -gt 0 ]]; then
            echo "Azure へ招待を開始します..."
            for user in "${to_add[@]}"; do
              echo "招待中: ${user}"
              if invite_json="$(az staticwebapp users invite \
                --name "$STATIC_WEB_APP_NAME" \
                --resource-group "$RESOURCE_GROUP" \
                --authentication-provider GitHub \
                --user-details "$user" \
                --domain "$domain" \
                --role github_collaborator \
                --invitation-expiration-in-hours "$expires" \
                --output json)"; then
                invite_success=$((invite_success + 1))
                invitation_url="$(echo "$invite_json" | jq -r '.invitationUrl // empty')"
                invitations+=("${user}|${invitation_url}")
                if [[ -n "$invitation_url" ]]; then
                  printf '  -> 招待URL: %s\n' "$invitation_url"
                fi
              else
                echo "::error::ユーザー招待に失敗しました: ${user}"
                invite_fail=$((invite_fail + 1))
              fi
            done
          fi

          remove_success=0
          remove_fail=0
          if [[ ${#to_remove_keys[@]} -gt 0 ]]; then
            echo "不要ユーザーを削除します..."
            for key in "${to_remove_keys[@]}"; do
              login="${azure_map[$key]}"
              display="${azure_display_map[$key]}"
              label="$login"
              if [[ -n "$display" && "$display" != "$login" ]]; then
                label="${display}（${login}）"
              fi
              echo "削除中: ${label}"

              args=(staticwebapp users update --name "$STATIC_WEB_APP_NAME" --resource-group "$RESOURCE_GROUP" --role anonymous)
              if [[ -n "${azure_id_map[$key]}" ]]; then
                args+=(--user-id "${azure_id_map[$key]}")
              else
                args+=(--user-details "${azure_map[$key]}")
                if [[ -n "${azure_provider_map[$key]}" ]]; then
                  args+=(--authentication-provider "${azure_provider_map[$key]}")
                fi
              fi

              if az "${args[@]}"; then
                remove_success=$((remove_success + 1))
              else
                echo "::error::ユーザー削除に失敗しました: ${label}"
                remove_fail=$((remove_fail + 1))
              fi
            done
          fi

          echo "招待成功: ${invite_success} 件 / 失敗: ${invite_fail} 件"
          echo "削除成功: ${remove_success} 件 / 失敗: ${remove_fail} 件"

          discussion_enabled=false
          if [[ -n "${DISCUSSION_ENABLED:-}" ]]; then
            value="$(echo "$DISCUSSION_ENABLED" | tr '[:upper:]' '[:lower:]')"
            if [[ "$value" == "true" ]]; then
              discussion_enabled=true
            fi
          fi

          discussion_title="${DISCUSSION_TITLE:-Azure Static Web App への招待: {username}}"

          template_content=""
          if $discussion_enabled; then
            if [[ -z "${DISCUSSION_CATEGORY_ID:-}" ]]; then
              echo "::error::SWA_DISCUSSION_CATEGORY_ID が必要です。"
              exit 1
            fi

            template_value="${DISCUSSION_BODY_TEMPLATE:-}"
            if [[ -n "$template_value" && -f "$template_value" ]]; then
              template_content="$(cat "$template_value")"
            elif [[ -n "$template_value" ]]; then
              template_content="$template_value"
            elif [[ -f "invitation-body-template.txt" ]]; then
              template_content="$(cat "invitation-body-template.txt")"
            else
              echo "::error::Discussion 用テンプレートが見つかりません。"
              exit 1
            fi
          fi

          discussion_post_success=0
          discussion_post_fail=0
          if $discussion_enabled && [[ ${#invitations[@]} -gt 0 ]]; then
            echo "GitHub Discussion に招待リンクを投稿します..."
            repo_id="$(gh api "repos/${repo}" --jq '.node_id')"
            for item in "${invitations[@]}"; do
              user="${item%%|*}"
              invitation_url="${item#*|}"
              if [[ -z "$user" ]]; then
                continue
              fi
              if [[ -z "$invitation_url" ]]; then
                echo "招待URLが未取得のため Discussion 投稿をスキップ: ${user}"
                continue
              fi

              title="$(replace_placeholders "$discussion_title" "$user" "$invitation_url")"
              body="$(replace_placeholders "$template_content" "$user" "$invitation_url")"
              mutation='mutation($repositoryId:ID!, $categoryId:ID!, $title:String!, $body:String!){ createDiscussion(input:{repositoryId:$repositoryId, categoryId:$categoryId, title:$title, body:$body}) { discussion { url } }}'

              if discussion_json="$(gh api graphql -f query="$mutation" -F repositoryId="$repo_id" -F categoryId="$DISCUSSION_CATEGORY_ID" -F title="$title" -F body="$body")"; then
                discussion_url="$(echo "$discussion_json" | jq -r '.data.createDiscussion.discussion.url // empty')"
                echo "Discussion 投稿成功: ${user} -> ${discussion_url}"
                discussion_post_success=$((discussion_post_success + 1))
              else
                echo "::error::Discussion 投稿に失敗しました: ${user}"
                discussion_post_fail=$((discussion_post_fail + 1))
              fi
            done
            echo "Discussion 投稿 成功: ${discussion_post_success} 件 / 失敗: ${discussion_post_fail} 件"
          elif $discussion_enabled; then
            echo "Discussion 投稿対象となる招待はありませんでした。"
          fi

          if [[ $invite_fail -gt 0 || $remove_fail -gt 0 ]]; then
            echo "::error::一部のユーザー同期に失敗しました。"
            exit 1
          fi

          if $discussion_enabled && [[ $discussion_post_fail -gt 0 ]]; then
            echo "::warning::一部の Discussion 投稿に失敗しました。"
          fi
